name: Create Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Git identity
      run: |
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

    - name: Extract version from script
      id: extract_version
      shell: pwsh
      run: |
        $content = Get-Content "wnn.ps1" -Raw
        if ($content -match '\$scriptVersion\s*=\s*"([0-9]+\.[0-9]+\.[0-9]+)"') {
            $version = $matches[1]
            "NEW_VERSION=$version" >> $env:GITHUB_ENV
            Write-Host "Found version: $version"
        } else {
            Write-Error "Could not find version string in wnn.ps1"
            exit 1
        }

    - name: Check if tag exists
      id: check_tag
      shell: bash
      run: |
        if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
          echo "TAG_EXISTS=true" >> $GITHUB_ENV
        else
          echo "TAG_EXISTS=false" >> $GITHUB_ENV
        fi

    # --- COMPILE PS2EXE ---
    - name: Compile PowerShell to EXE
      if: env.TAG_EXISTS == 'false'
      shell: pwsh
      run: |
        Install-Module -Name ps2exe -Force -Scope CurrentUser
        Invoke-PS2EXE -InputFile "wnn.ps1" `
                      -OutputFile "wnn.exe" `
                      -noConsole `
                      -title "Wallpaper Name Notifier" `
                      -description "Monitors wallpaper changes" `
                      -company "UnalignedCoder" `
                      -version "${{ env.NEW_VERSION }}" `
                      -iconFile "wnn.ico"
    # -----------------------------

    - name: Create and push tag (if it doesn't exist)
      if: env.TAG_EXISTS == 'false'
      shell: bash
      run: |
        git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
        git push origin "v$NEW_VERSION"

    - name: Extract release notes from script
      id: extract_notes
      shell: pwsh
      run: |
        $content = Get-Content "wnn.ps1" -Raw
        # Uses regex to find text between .NOTES and the closing #>
        if ($content -match '(?s)\.NOTES(.*?)(?=#>)') {
            $notes = $matches[1].Trim()
            "RELEASE_NOTES<<EOF" >> $env:GITHUB_ENV
            $notes >> $env:GITHUB_ENV
            "EOF" >> $env:GITHUB_ENV
        }

    - name: Zip files
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release_dist
        Copy-Item wnn.ps1, wnn.ini, wnn.exe -Destination release_dist/
        Compress-Archive -Path release_dist/* -DestinationPath "wnn-v${{ env.NEW_VERSION }}.zip" -Force
        "ZIP_FILE=wnn-v${{ env.NEW_VERSION }}.zip" >> $env:GITHUB_ENV

    - name: Create Release
      if: env.TAG_EXISTS == 'false'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.NEW_VERSION }}
        name: Release v${{ env.NEW_VERSION }}
        body: ${{ env.RELEASE_NOTES }}
        files: |
          ${{ env.ZIP_FILE }}
          wnn.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}